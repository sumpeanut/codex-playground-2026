<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CA Test Suite Coordinator</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: system-ui, sans-serif;
      }
      body {
        margin: 0;
        background: #0f0f0f;
        color: #e5e5e5;
      }
      header {
        padding: 24px;
        border-bottom: 1px solid #222;
        background: #131313;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 22px;
      }
      main {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px;
        display: grid;
        gap: 20px;
      }
      .card {
        border: 1px solid #222;
        border-radius: 12px;
        padding: 16px 18px;
        background: #151515;
      }
      .controls {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        align-items: end;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 13px;
        color: #bdbdbd;
      }
      select,
      input[type='range'] {
        background: #101010;
        border: 1px solid #2b2b2b;
        color: #e5e5e5;
        border-radius: 8px;
        padding: 8px;
      }
      input[type='range'] {
        padding: 0;
      }
      .actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      button {
        background: #1e1e1e;
        border: 1px solid #2b2b2b;
        color: #e5e5e5;
        border-radius: 8px;
        padding: 10px 14px;
        cursor: pointer;
      }
      button:hover:enabled {
        background: #262626;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .summary {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        font-size: 14px;
      }
      .summary span {
        background: #111;
        border: 1px solid #222;
        padding: 6px 10px;
        border-radius: 999px;
      }
      .test-list {
        margin: 8px 0 0;
        padding-left: 18px;
        font-size: 13px;
        color: #bdbdbd;
      }
      .iframe-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
      }
      .iframe-wrap {
        border: 1px solid #222;
        border-radius: 10px;
        overflow: hidden;
        background: #0c0c0c;
        min-height: 220px;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        border-bottom: 1px solid #222;
        padding: 8px;
        text-align: left;
        vertical-align: top;
      }
      th {
        color: #7fd0ff;
      }
      tbody tr:nth-child(even) {
        background: #121212;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #222;
      }
      .status-idle {
        color: #cfcfcf;
      }
      .status-running {
        color: #ffe18a;
      }
      .status-pass {
        color: #7dff9a;
      }
      .status-fail {
        color: #ff8a8a;
      }
      pre {
        margin: 0;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        color: #c9c9c9;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>CA Test Suite Coordinator</h1>
      <p>Run HTML test harnesses in sequence or in parallel with aggregated reporting.</p>
    </header>
    <main>
      <section class="card">
        <div class="controls">
          <label>
            Mode
            <select id="mode-select">
              <option value="sequential">Sequential</option>
              <option value="parallel">Parallel</option>
            </select>
          </label>
          <label>
            Concurrency
            <input id="concurrency" type="range" min="1" max="9" value="3" />
            <span id="concurrency-value">3</span>
          </label>
          <label>
            Test list
            <select id="suite-select"></select>
          </label>
        </div>
        <div class="actions" style="margin-top: 12px">
          <button id="run-button">Run suite</button>
          <button id="stop-button" disabled>Stop</button>
          <button id="reset-button">Reset</button>
        </div>
        <div class="summary" style="margin-top: 12px">
          <span id="summary-total">Total: 0</span>
          <span id="summary-pass">Passed: 0</span>
          <span id="summary-fail">Failed: 0</span>
          <span id="summary-running">Running: 0</span>
        </div>
        <ul id="test-list" class="test-list"></ul>
      </section>

      <section class="card">
        <h2>Frame Pool</h2>
        <div id="iframe-grid" class="iframe-grid"></div>
      </section>

      <section class="card">
        <h2>Results</h2>
        <table>
          <thead>
            <tr>
              <th>Test</th>
              <th>Status</th>
              <th>Result</th>
              <th>Logs</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
      </section>
    </main>

    <script>
      const suites = {
        'All tests': [
          { name: 'Pathfinding tests', path: './test-pathfinding.html' },
          { name: 'Support cell tests', path: './test-support-cells.html' },
          { name: 'Stability tests', path: './test-stability.html' },
          { name: 'Structure sandbox', path: './test-structures.html' },
          { name: 'Editor tests', path: './test-structure-editor.html' },
          { name: 'Performance tests', path: './test-performance.html' }
        ],
        'Core suite (no performance)': [
          { name: 'Pathfinding tests', path: './test-pathfinding.html' },
          { name: 'Support cell tests', path: './test-support-cells.html' },
          { name: 'Stability tests', path: './test-stability.html' },
          { name: 'Structure sandbox', path: './test-structures.html' },
          { name: 'Editor tests', path: './test-structure-editor.html' }
        ],
        'Performance only': [{ name: 'Performance tests', path: './test-performance.html' }]
      };

      const state = {
        running: false,
        mode: 'sequential',
        concurrency: 3,
        suiteKey: 'All tests',
        queue: [],
        results: new Map(),
        frames: [],
        frameByWindow: new Map(),
        activeByFrame: new Map(),
        runningCount: 0
      };

      const modeSelect = document.getElementById('mode-select');
      const concurrencyInput = document.getElementById('concurrency');
      const concurrencyValue = document.getElementById('concurrency-value');
      const suiteSelect = document.getElementById('suite-select');
      const testList = document.getElementById('test-list');
      const runButton = document.getElementById('run-button');
      const stopButton = document.getElementById('stop-button');
      const resetButton = document.getElementById('reset-button');
      const iframeGrid = document.getElementById('iframe-grid');
      const resultsBody = document.getElementById('results-body');
      const summaryTotal = document.getElementById('summary-total');
      const summaryPass = document.getElementById('summary-pass');
      const summaryFail = document.getElementById('summary-fail');
      const summaryRunning = document.getElementById('summary-running');

      function syncSuiteOptions() {
        suiteSelect.innerHTML = '';
        Object.keys(suites).forEach((key) => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = key;
          suiteSelect.appendChild(option);
        });
        suiteSelect.value = state.suiteKey;
      }

      function renderTestList() {
        testList.innerHTML = '';
        const tests = suites[state.suiteKey] || [];
        tests.forEach((test) => {
          const li = document.createElement('li');
          li.textContent = test.name;
          testList.appendChild(li);
        });
      }

      function renderSummary() {
        const total = state.queue.length + state.results.size + state.runningCount;
        let passCount = 0;
        let failCount = 0;
        state.results.forEach((value) => {
          if (value.passed === true) {
            passCount += 1;
          } else if (value.passed === false) {
            failCount += 1;
          }
        });
        summaryTotal.textContent = `Total: ${total}`;
        summaryPass.textContent = `Passed: ${passCount}`;
        summaryFail.textContent = `Failed: ${failCount}`;
        summaryRunning.textContent = `Running: ${state.runningCount}`;
      }

      function updateResultRow(name, update) {
        const existing = state.results.get(name) || { name, status: 'idle' };
        const next = { ...existing, ...update };
        state.results.set(name, next);

        let row = resultsBody.querySelector(`tr[data-name="${CSS.escape(name)}"]`);
        if (!row) {
          row = document.createElement('tr');
          row.dataset.name = name;
          row.innerHTML = `
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          `;
          resultsBody.appendChild(row);
        }
        row.children[0].textContent = name;
        const statusPill = document.createElement('span');
        statusPill.className = `status-pill status-${next.status || 'idle'}`;
        statusPill.textContent = next.status || 'idle';
        row.children[1].innerHTML = '';
        row.children[1].appendChild(statusPill);
        row.children[2].textContent = next.passed === undefined ? '' : next.passed ? 'Pass' : 'Fail';
        const log = next.details ? JSON.stringify(next.details, null, 2) : '';
        row.children[3].innerHTML = log ? `<pre>${log}</pre>` : '';
        renderSummary();
      }

      function resetResults() {
        state.queue = [];
        state.results.clear();
        state.runningCount = 0;
        resultsBody.innerHTML = '';
        renderSummary();
      }

      function stopRun() {
        state.running = false;
        state.queue = [];
        state.runningCount = 0;
        state.activeByFrame.clear();
        state.frames.forEach((frame) => {
          frame.src = 'about:blank';
        });
        runButton.disabled = false;
        stopButton.disabled = true;
        modeSelect.disabled = false;
        suiteSelect.disabled = false;
        concurrencyInput.disabled = false;
        renderSummary();
      }

      function buildFrames(count) {
        iframeGrid.innerHTML = '';
        state.frames = [];
        state.frameByWindow.clear();
        state.activeByFrame.clear();
        for (let i = 0; i < count; i += 1) {
          const wrap = document.createElement('div');
          wrap.className = 'iframe-wrap';
          const frame = document.createElement('iframe');
          frame.setAttribute('sandbox', 'allow-scripts allow-same-origin');
          frame.title = `Test frame ${i + 1}`;
          wrap.appendChild(frame);
          iframeGrid.appendChild(wrap);
          state.frames.push(frame);
        }
      }

      function nextTest() {
        return state.queue.shift();
      }

      function startTestOnFrame(frame, test) {
        state.activeByFrame.set(frame, test);
        state.runningCount += 1;
        updateResultRow(test.name, { status: 'running' });
        const url = new URL(test.path, window.location.href);
        url.searchParams.set('autorun', '1');
        frame.src = url.toString();
      }

      function dispatchNext(frame) {
        const test = nextTest();
        if (!test) {
          state.activeByFrame.delete(frame);
          return;
        }
        startTestOnFrame(frame, test);
      }

      function startRun() {
        resetResults();
        const tests = suites[state.suiteKey] || [];
        state.queue = [...tests];
        state.running = true;
        runButton.disabled = true;
        stopButton.disabled = false;
        modeSelect.disabled = true;
        suiteSelect.disabled = true;
        concurrencyInput.disabled = true;

        const frameCount = state.mode === 'sequential' ? 1 : state.concurrency;
        buildFrames(frameCount);
        state.frames.forEach((frame) => dispatchNext(frame));
        renderSummary();
      }

      window.addEventListener('message', (event) => {
        const data = event.data;
        if (!data || !data.type) {
          return;
        }
        if (data.type !== 'ca-test-status' && data.type !== 'ca-test-result') {
          return;
        }
        const frame = state.frames.find((candidate) => candidate.contentWindow === event.source);
        if (!frame) {
          return;
        }
        const activeTest = state.activeByFrame.get(frame);
        const testName = activeTest?.name || data.name || 'Unknown';

        if (data.type === 'ca-test-status') {
          updateResultRow(testName, { status: data.status || 'running', details: data.details || null });
          return;
        }

        if (data.type === 'ca-test-result') {
          updateResultRow(testName, {
            status: data.passed ? 'pass' : 'fail',
            passed: Boolean(data.passed),
            details: data.details || null
          });
          state.runningCount = Math.max(0, state.runningCount - 1);
          if (state.running) {
            dispatchNext(frame);
          }
          if (state.queue.length === 0 && state.runningCount === 0) {
            stopRun();
          } else {
            renderSummary();
          }
        }
      });

      modeSelect.addEventListener('change', (event) => {
        state.mode = event.target.value;
        concurrencyInput.disabled = state.mode === 'sequential';
      });

      concurrencyInput.addEventListener('input', (event) => {
        state.concurrency = Number(event.target.value);
        concurrencyValue.textContent = String(state.concurrency);
      });

      suiteSelect.addEventListener('change', (event) => {
        state.suiteKey = event.target.value;
        renderTestList();
      });

      runButton.addEventListener('click', () => {
        if (!state.running) {
          startRun();
        }
      });

      stopButton.addEventListener('click', () => {
        stopRun();
      });

      resetButton.addEventListener('click', () => {
        if (state.running) {
          stopRun();
        }
        resetResults();
      });

      syncSuiteOptions();
      renderTestList();
      renderSummary();
      concurrencyValue.textContent = String(state.concurrency);
      concurrencyInput.disabled = state.mode === 'sequential';
      buildFrames(state.mode === 'sequential' ? 1 : state.concurrency);
    </script>
  </body>
</html>
